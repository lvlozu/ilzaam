<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kanbulo - The Movie | Booking For N. Miladhoo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* JPG default so there's never a white flash; GIF swaps in when loaded */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('BG.jpg') center/cover no-repeat;
      z-index: -1;
    }
    body.gif-bg::before {
      background-image: url('BG.gif?v=2'); /* cache-buster */
    }

    .seat {
      width: 34px; height: 34px;
      font-size: 12px; border-radius: 4px;
      line-height: 34px; text-align: center;
    }
    .seat.booked, .seat.confirmed { background-color: #9ca3af; color: white; cursor: not-allowed; }
    .seat.selected { background-color: #fb923c; color: white; }
    .screenA .seat { border: 2px solid #60a5fa; }
    .screenB .seat { border: 2px solid #f472b6; }
    .screenC .seat { border: 2px solid #34d399; }

    /* Base cinematic outline: thinner (1px ~ 50% of old 2px) + yellow fill */
    .text-outline {
      color: #ffd400;                 /* yellow fill */
      -webkit-text-stroke: 1px #000;  /* thin black outline */
      text-stroke: 1px #000;
      letter-spacing: 0.06em;
      font-weight: 700;
      font-family: "Cinzel", "Trajan Pro", Georgia, serif;
    }
    /* Heading-specific fills with thin black outline preserved */
    .text-center h1.text-outline { color: #e11d48; }             /* Welcome to ‚Üí red */
    .text-center h2.text-outline { color: #60a5fa; font-weight: 800; } /* Kanbulo ‚Äì The Movie ‚Üí light blue + bolder */
    .text-center h3.text-outline { color: #d946ef; }             /* Booking For N. Miladhoo ‚Üí magenta */

    /* Pre-booking instructions: yellow, bulleted, readable */
    #instructions { text-align: left; max-width: 42rem; margin-left:auto; margin-right:auto; }
    #instructions ul { margin: 0; padding: 0; }
    #instructions ul li { list-style: none; display:flex; align-items:flex-start; }
    #instructions ul li span { flex-shrink:0; }
  </style>
</head>
<body class="min-h-screen p-4">

  <!-- Header -->
  <div class="text-center mb-4">
    <h1 class="text-2xl font-bold text-outline mb-1">Welcome to</h1>
    <h2 class="text-xl font-bold text-outline mb-1">Kanbulo - The Movie</h2>
    <h3 class="text-lg font-medium text-outline mb-4">Booking For N. Miladhoo</h3>
  </div>

  <!-- Pre-Booking Instructions (yellow, left-aligned, icon-bulleted) -->
  <div id="instructions" class="p-4 rounded mb-4 max-w-2xl mx-auto">
    <ul class="space-y-3 text-yellow-400 font-semibold text-base leading-relaxed">
      <li class="flex items-start">
        <span class="mr-2">üìç</span> Venue: Miladhoo Youth Center
      </li>
      <li class="flex items-start">
        <span class="mr-2">üìÖ</span> Date: 12th September 2025 (Friday Night)
      </li>
      <li class="flex items-start">
        <span class="mr-2">‚úÖ</span> Ticket Price: 150/- per ticket
      </li>
      <li class="flex items-start">
        <span class="mr-2">üì§</span> Booker is fully responsible for all seats booked and must make full payment.
      </li>
      <li class="flex items-start">
        <span class="mr-2">üü©</span> Maximum of 5 seats allowed per booking.
      </li>
    </ul>

    <div class="mt-6 text-yellow-400">
      <p class="font-semibold mb-2">üí≥ Payment Account</p>
      <p id="payAcc" class="mb-2 font-mono">7730000654882 (BIZOLVE)</p>
      <button onclick="copyAcc()" class="bg-green-600 px-3 py-1 rounded text-white text-sm">Copy</button>
    </div>

    <!-- Trailer Section -->
    <div id="trailerSection" class="mt-8 text-center">
      <p class="font-semibold mb-3 text-yellow-400">üé¨ Official Trailer</p>
      <div class="relative w-full max-w-lg mx-auto" style="padding-bottom: 56.25%; background:#000;">
        <div id="trailerOverlay" 
             class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center bg-black/70 text-white rounded">
          <p class="mb-3">Watch the Kanbulo Trailer</p>
          <button onclick="playTrailer()" class="bg-red-600 px-4 py-2 rounded mb-3">‚ñ∂ Play Trailer</button>
          <button onclick="skipToBooking()" class="bg-green-600 px-4 py-2 rounded">‚û° Skip to Booking</button>
        </div>
        <iframe id="trailerFrame" 
                class="absolute top-0 left-0 w-full h-full rounded hidden"
                src=""
                title="Kanbulo Trailer"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen>
        </iframe>
      </div>
      <button id="toBookingAfterTrailer" 
              onclick="skipToBooking()" 
              class="mt-4 bg-green-600 px-4 py-2 rounded hidden">
        ‚û° Proceed to Booking
      </button>
    </div>
  </div>

  <!-- Step 1 -->
  <div id="step1" class="hidden mb-4 text-center">
    <input id="fullName" type="text" placeholder="Full Name" class="border p-2 w-full mb-3 text-black rounded">
    <input id="phone" type="number" placeholder="Contact Number (7xxxxxxx or 9xxxxxxx)" class="border p-2 w-full mb-3 text-black rounded">
    <button onclick="proceedToSeats()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Next</button>
  </div>

  <!-- Seat Selection -->
  <div id="seatSection" class="hidden">
    <h2 class="text-lg font-bold text-center mb-3 text-outline">Choose Your Seats (Max 5)</h2>
    <div class="grid grid-cols-1 gap-6">
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen A</h3>
        <div id="screenA" class="screenA"></div>
      </div>
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen B</h3>
        <div id="screenB" class="screenB"></div>
      </div>
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen C</h3>
        <div id="screenC" class="screenC"></div>
      </div>
    </div>
    <div id="namesArea" class="mt-4"></div>
    <button onclick="submitBooking()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Submit Booking</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLb5aZcLr8L-l5ve3se3-nPNNA_6hU1VE",
  authDomain: "miladhoobooking.firebaseapp.com",
  databaseURL: "https://miladhoobooking-default-rtdb.firebaseio.com",
  projectId: "miladhoobooking",
  storageBucket: "miladhoobooking.appspot.com",
  messagingSenderId: "762620004750",
  appId: "1:762620004750:web:3bf9bbc843f54499673cdf"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const screens = { screenA: { rows: 9, cols: 9 }, screenB: { rows: 10, cols: 10 }, screenC: { rows: 9, cols: 9 } };
let selectedSeats = [];

window.copyAcc = () => {
  const acc = document.getElementById("payAcc").innerText;
  navigator.clipboard.writeText(acc).then(() => alert("Account copied: " + acc));
};

window.playTrailer = () => {
  document.getElementById('trailerOverlay').classList.add('hidden');
  const frame = document.getElementById('trailerFrame');
  frame.src = "https://www.youtube.com/embed/x2QU5uMFWJs?rel=0"; // new trailer
  frame.classList.remove('hidden');
  document.getElementById('toBookingAfterTrailer').classList.remove('hidden');
};

window.skipToBooking = () => {
  document.getElementById("instructions").classList.add("hidden");
  document.getElementById("step1").classList.remove("hidden");
  window.scrollTo({ top: document.getElementById("step1").offsetTop, behavior: 'smooth' });

  // optional: clean URL and clear the session flag
  if (history.replaceState && (location.hash === "#book")) {
    history.replaceState(null, "", location.pathname + location.search);
  }
  sessionStorage.removeItem("skipLanding");
};

window.proceedToSeats = () => {
  const name = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (!name || !/^([79])\d{6}$/.test(phone)) return alert("‚ùå Enter valid name and contact (7xxxxxxx or 9xxxxxxx)");
  document.getElementById("step1").classList.add("hidden");
  document.getElementById("seatSection").classList.remove("hidden");
};

function renderScreens() {
  for (const [screenId, { rows, cols }] of Object.entries(screens)) {
    const container = document.getElementById(screenId);
    let seatCounter = 1;
    for (let r = 1; r <= rows; r++) {
      const row = document.createElement("div");
      row.className = `grid grid-cols-${cols} gap-1 mb-1`;
      const rowSeats = [];
      for (let c = 1; c <= cols; c++) {
        const trueCol = r % 2 === 0 ? cols - c + 1 : c;
        const seatNum = seatCounter++;
        const seatId = `${screenId}-${seatNum}`;
        const el = document.createElement("div");
        el.className = "seat";
        el.textContent = seatNum;
        el.dataset.id = seatId;
        el.onclick = () => toggleSelect(seatId);
        rowSeats[trueCol - 1] = el;
      }
      rowSeats.forEach(seat => row.appendChild(seat));
      container.appendChild(row);
    }
  }
}

function toggleSelect(seatId) {
  const el = document.querySelector(`[data-id='${seatId}']`);
  if (!el || el.classList.contains("booked") || el.classList.contains("confirmed")) return;
  if (el.classList.contains("selected")) {
    el.classList.remove("selected");
    selectedSeats = selectedSeats.filter(s => s.seatId !== seatId);
  } else {
    if (selectedSeats.length >= 5) return alert("Max 5 seats allowed");
    el.classList.add("selected");
    selectedSeats.push({ seatId, name: "" });
  }
  updateNamesArea();
}

function updateNamesArea() {
  const area = document.getElementById("namesArea");
  area.innerHTML = selectedSeats.map((s, i) => `
    <div class="my-1">${s.seatId}: 
      <input placeholder="Name for seat" class="border p-1 w-64 text-black rounded" data-index="${i}" value="${s.name || ''}">
    </div>
  `).join("");
  area.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", e => selectedSeats[+e.target.dataset.index].name = e.target.value.trim());
  });
}

window.submitBooking = () => {
  const fullName = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (selectedSeats.length === 0 || selectedSeats.some(s => !s.name.trim())) return alert("Fill all names and select seats");
  localStorage.setItem("bookingFullName", fullName);
  localStorage.setItem("bookingPhone", phone);
  localStorage.setItem("selectedSeats", JSON.stringify(selectedSeats));

  onValue(ref(db, "bookings"), snap => {
    const data = snap.val();
    const bookedNow = selectedSeats.filter(s => Object.values(data || {}).some(b => b.seatId === s.seatId && (b.status === 'booked' || b.status === 'confirmed')));
    if (bookedNow.length > 0) return alert("Some seats just got booked. Refresh or choose others.");

    const dataRef = ref(db, "bookings");
    const promises = selectedSeats.map(seat => push(dataRef, {
      seatId: seat.seatId, screen: seat.seatId.split('-')[0], seat: seat.seatId.split('-')[1],
      name: seat.name, status: "booked", fullName, phone
    }));
    Promise.all(promises).then(() => window.location.href = "thankyou.html").catch(() => window.location.href = "error.html");
  }, { onlyOnce: true });
};

renderScreens();
onValue(ref(db, "bookings"), snap => {
  const data = snap.val();
  if (!data) return;
  for (const b of Object.values(data)) {
    const el = document.querySelector(`[data-id='${b.seatId}']`);
    if (el) el.classList.add(b.status);
  }
});

// --- Progressive GIF loader (prevents blank if GIF slow or missing)
(function(){
  const img = new Image();
  img.onload  = () => document.body.classList.add('gif-bg');
  img.onerror = () => console.warn('BG.gif failed to load (path/case?) ‚Äì using JPG fallback.');
  img.src = 'BG.gif?v=2';
})();

// --- Auto-skip landing if coming from thankyou (index.html#book) or flag
window.addEventListener("DOMContentLoaded", () => {
  if (location.hash === "#book" || sessionStorage.getItem("skipLanding") === "1") {
    skipToBooking();
  }
});
</script>
</body>
</html>
