<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ILZAAM - The Movie | Booking For N. Miladhoo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Background: JPG default (no white flash) -> swap to GIF when loaded */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('BG.jpg') center/cover no-repeat;
      z-index: -2; /* below scrim */
    }
    body.gif-bg::before { background-image: url('BG.gif?v=2'); }

    /* Soft scrim/vignette for contrast (not a box, no blur) */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,0.22) 55%,
          rgba(0,0,0,0.45) 100%),
        linear-gradient(to bottom,
          rgba(0,0,0,0.35) 0%,
          rgba(0,0,0,0) 30%,
          rgba(0,0,0,0) 70%,
          rgba(0,0,0,0.35) 100%);
      pointer-events: none;
      z-index: -1; /* over BG, under content */
    }

    /* Readability boost (avoid affecting inputs) */
    .readable :where(h1,h2,h3,p,li,span,strong,em,small,label,div) {
      text-shadow:
        0 1px 2px rgba(0,0,0,0.85),
        0 0 12px rgba(0,0,0,0.55);
    }

    .seat {
      width: 34px; height: 34px;
      font-size: 12px; border-radius: 4px;
      line-height: 34px; text-align: center;
    }
    .seat.booked, .seat.confirmed { background-color: #9ca3af; color: white; cursor: not-allowed; }
    .seat.selected { background-color: #fb923c; color: white; }
    .screenA .seat { border: 2px solid #60a5fa; }
    .screenB .seat { border: 2px solid #f472b6; }
    .screenC .seat { border: 2px solid #34d399; }

    /* Base cinematic outline: thinner (1px) + yellow fill */
    .text-outline {
      color: #ffd400;                 /* yellow fill */
      -webkit-text-stroke: 1px #000;  /* thin black outline */
      text-stroke: 1px #000;
      letter-spacing: 0.06em;
      font-weight: 700;
      font-family: "Cinzel", "Trajan Pro", Georgia, serif;
    }
    /* Heading-specific fills (outline preserved) */
    .text-center h1.text-outline { color: #e11d48; }                 /* Welcome to → red */
    .text-center h2.text-outline { color: #60a5fa; font-weight: 800; }/* ILZAAM – The Movie → light blue + bolder */

    /* Uniform yellow, tight, icon-bulleted instruction list */
    #instructions { text-align: left; max-width: 42rem; margin-left: auto; margin-right: auto; }
    #instructions ul { margin: 0; padding: 0; }
    #instructions ul li { list-style: none; display: flex; align-items: flex-start; }
    #instructions ul li span { flex-shrink: 0; }

    /* Trailer wrapper: fully transparent ALWAYS */
    .videoWrap { position: relative; width: 100%; max-width: 32rem; margin: 0 auto; background: transparent; }
    .videoWrap::before { content: ""; display: block; padding-bottom: 56.25%; }
    .videoWrap > * { position: absolute; inset: 0; width: 100%; height: 100%; }
    #trailerOverlay { background: transparent !important; }
  </style>
</head>
<body class="min-h-screen p-4 text-gray-100">

  <!-- Header -->
  <div class="text-center mb-4 readable">
    <h1 class="text-2xl font-bold text-outline mb-1">Welcome to</h1>
    <h2 class="text-xl font-bold text-outline mb-1">ILZAAM - The Movie</h2>
  </div>

  <!-- Pre-Booking Instructions -->
  <div id="instructions" class="p-4 rounded mb-4 max-w-2xl mx-auto readable">
    <ul class="space-y-1 text-yellow-400 font-semibold text-base leading-snug">
      <li class="flex items-start"><span class="mr-2">📍</span> Venue: Miladhoo Youth Center</li>
      <li class="flex items-start"><span class="mr-2">📅</span> Date: 31st October 2025 (Friday Night)</li>
      <li class="flex items-start"><span class="mr-2">✅</span> Ticket Price: 150/- per ticket</li>
      <li class="flex items-start"><span class="mr-2">📤</span> Booker is fully responsible for all seats booked and must make full payment.</li>
      <li class="flex items-start"><span class="mr-2">🟩</span> Maximum of 5 seats allowed per booking.</li>
    </ul>

    <div class="mt-4 text-yellow-400">
      <p class="font-semibold mb-1">💳 Payment Account</p>
      <p id="payAcc" class="mb-2 font-mono">7730000654882 (BIZOLVE)</p>
      <button onclick="copyAcc()" class="bg-green-600 px-3 py-1 rounded text-white text-sm">Copy</button>
    </div>

    <!-- Trailer Section -->
    <div id="trailerSection" class="mt-6 text-center readable">
      <p class="font-semibold mb-2 text-yellow-400">🎬 Official Trailer</p>
      <div id="trailerWrap" class="videoWrap">
        <!-- Transparent overlay with initial buttons -->
        <div id="trailerOverlay" class="flex flex-col items-center justify-center">
          <div class="flex flex-col sm:flex-row gap-3">
            <button onclick="playTrailer(0)" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">▶ Play Trailer 1</button>
            <button onclick="playTrailer(1)" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">▶ Play Trailer 2</button>
            <button onclick="skipToBooking()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">➡ Skip to Booking</button>
          </div>
        </div>

        <!-- HTML5 Video -->
        <video id="trailerVideo"
               class="hidden rounded"
               controls
               preload="metadata"
               playsinline
               webkit-playsinline
               poster="poster.jpg">
          <!-- source inserted by JS -->
        </video>
      </div>

      <!-- Actions under the player: switch trailers + proceed -->
      <div id="trailerActions" class="mt-4 flex flex-wrap items-center justify-center gap-2 hidden">
        <button id="playT1" onclick="playTrailer(0)" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">▶ Trailer 1</button>
        <button id="playT2" onclick="playTrailer(1)" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">▶ Trailer 2</button>
        <button id="toBookingAfterTrailer" onclick="skipToBooking()" class="bg-green-600 px-4 py-2 rounded">➡ Proceed to Booking</button>
      </div>

      <!-- Dhivehi footnote, centered & RTL -->
      <p id="trailerNote" dir="rtl" class="mt-3 text-center text-yellow-300 text-sm readable hidden">
        މިއީ ކާމިޔާބު ދިވެހި ފިލްމް ސްޓާރ ޔޫސުފް ޝަފީޢު (ޔޫއްޕެ) ގެ ވަރަށް ޚައްސަ ފިލްމެއް! ޔޫއްޕެ އަކީ ރީތި އަދި ޔާމިޔާބު އެތަކެއް ފިލްމެއްގައި އެކްޓްކޮށް އަދި ޑައިރެކްޓްކޮށްފައިވާ ކުޅަދާނަ ފަންނާނެއް!
      </p>
    </div>
  </div>

  <!-- Step 1 (white card retained) -->
  <div id="step1" class="hidden mb-4">
    <div class="max-w-md mx-auto bg-white rounded shadow p-4">
      <div class="text-center mb-2 readable"><p class="font-semibold text-gray-900">Your Details</p></div>
      <input id="fullName" type="text" placeholder="Full Name" class="border p-2 w-full mb-3 text-black rounded bg-white">
      <input id="phone" type="number" placeholder="Contact Number (7xxxxxxx or 9xxxxxxx)" class="border p-2 w-full mb-3 text-black rounded bg-white">
      <button onclick="proceedToSeats()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Next</button>
    </div>
  </div>

  <!-- Seat Selection -->
  <div id="seatSection" class="hidden readable">
    <h2 class="text-lg font-bold text-center mb-3 text-outline">Choose Your Seats (Max 5)</h2>
    <div class="grid grid-cols-1 gap-6">
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen A</h3>
        <div id="screenA" class="screenA"></div>
      </div>
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen B</h3>
        <div id="screenB" class="screenB"></div>
      </div>
      <div>
        <h3 class="text-red-400 font-semibold mb-1 text-center">Screen C</h3>
        <div id="screenC" class="screenC"></div>
      </div>
    </div>
    <div id="namesArea" class="mt-4"></div>
    <button onclick="submitBooking()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Submit Booking</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLb5aZcLr8L-l5ve3se3-nPNNA_6hU1VE",
  authDomain: "miladhoobooking.firebaseapp.com",
  databaseURL: "https://miladhoobooking-default-rtdb.firebaseio.com",
  projectId: "miladhoobooking",
  storageBucket: "miladhoobooking.appspot.com",
  messagingSenderId: "762620004750",
  appId: "1:762620004750:web:3bf9bbc843f54499673cdf"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const screens = { screenA: { rows: 9, cols: 9 }, screenB: { rows: 10, cols: 10 }, screenC: { rows: 9, cols: 9 } };
let selectedSeats = [];

/* ---------- ACCOUNT COPY ---------- */
window.copyAcc = () => {
  const acc = document.getElementById("payAcc").innerText;
  navigator.clipboard.writeText(acc).then(() => alert("Account copied: " + acc));
};

/* ---------- TRAILER: TWO LOCAL MP4S ---------- */
const videoSources = [
  { label: "TRAILER 1", src: "./TRAILER%201.mp4" },
  { label: "TRAILER 2", src: "./TRAILER%202.mp4" },
  // If renamed: { label: "TRAILER 1", src: "./trailer1.mp4" },
  //             { label: "TRAILER 2", src: "./trailer2.mp4" },
];

function setTrailerButtonsState(activeIndex) {
  const t1 = document.getElementById('playT1');
  const t2 = document.getElementById('playT2');

  // Enable both first
  [t1, t2].forEach(btn => {
    btn.removeAttribute('disabled');
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
  });

  // Disable the one that's currently playing
  if (activeIndex === 0 && t1) {
    t1.setAttribute('disabled', 'true');
    t1.classList.add('opacity-50', 'cursor-not-allowed');
  }
  if (activeIndex === 1 && t2) {
    t2.setAttribute('disabled', 'true');
    t2.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

window.playTrailer = (index = 0) => {
  const chosen = videoSources[index] || videoSources[0];

  const overlay = document.getElementById('trailerOverlay');
  const video   = document.getElementById('trailerVideo');
  const actions = document.getElementById('trailerActions');
  const note    = document.getElementById('trailerNote');

  if (overlay) overlay.classList.add('hidden');

  if (video.getAttribute('data-current-src') !== chosen.src) {
    video.pause();
    video.removeAttribute('src');
    while (video.firstChild) video.removeChild(video.firstChild);
    const source = document.createElement('source');
    source.src = chosen.src;
    source.type = 'video/mp4';
    video.appendChild(source);
    video.setAttribute('data-current-src', chosen.src);
    video.load();
  }

  video.classList.remove('hidden');
  actions.classList.remove('hidden');
  note.classList.remove('hidden');

  setTrailerButtonsState(index);

  video.play().catch(() => {
    console.warn('Autoplay blocked; waiting for user interaction.');
  });
};

/* ---------- FLOW ---------- */
window.skipToBooking = () => {
  document.getElementById("instructions").classList.add("hidden");
  document.getElementById("step1").classList.remove("hidden");
  window.scrollTo({ top: document.getElementById("step1").offsetTop, behavior: 'smooth' });

  if (history.replaceState && (location.hash === "#book")) {
    history.replaceState(null, "", location.pathname + location.search);
  }
  sessionStorage.removeItem("skipLanding");
};

window.proceedToSeats = () => {
  const name = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (!name || !/^([79])\d{6}$/.test(phone)) return alert("❌ Enter valid name and contact (7xxxxxxx or 9xxxxxxx)");
  document.getElementById("step1").classList.add("hidden");
  document.getElementById("seatSection").classList.remove("hidden");
};

/* ---------- SEATS RENDER ---------- */
function renderScreens() {
  for (const [screenId, { rows, cols }] of Object.entries(screens)) {
    const container = document.getElementById(screenId);
    let seatCounter = 1;
    for (let r = 1; r <= rows; r++) {
      const row = document.createElement("div");
      row.className = `grid grid-cols-${cols} gap-1 mb-1`;
      const rowSeats = [];
      for (let c = 1; c <= cols; c++) {
        const trueCol = r % 2 === 0 ? cols - c + 1 : c;
        const seatNum = seatCounter++;
        const seatId = `${screenId}-${seatNum}`;
        const el = document.createElement("div");
        el.className = "seat";
        el.textContent = seatNum;
        el.dataset.id = seatId;
        el.onclick = () => toggleSelect(seatId);
        rowSeats[trueCol - 1] = el;
      }
      rowSeats.forEach(seat => row.appendChild(seat));
      container.appendChild(row);
    }
  }
}

function toggleSelect(seatId) {
  const el = document.querySelector(`[data-id='${seatId}']`);
  if (!el || el.classList.contains("booked") || el.classList.contains("confirmed")) return;

  // Prevent booking of any screenC seats
  if (seatId.startsWith("screenC-")) return alert("❌ Screen C seats are unavailable.");

  if (el.classList.contains("selected")) {
    el.classList.remove("selected");
    selectedSeats = selectedSeats.filter(s => s.seatId !== seatId);
  } else {
    if (selectedSeats.length >= 5) return alert("Max 5 seats allowed");
    el.classList.add("selected");
    selectedSeats.push({ seatId, name: "" });
  }
  updateNamesArea();
}

  if (el.classList.contains("selected")) {
    el.classList.remove("selected");
    selectedSeats = selectedSeats.filter(s => s.seatId !== seatId);
  } else {
    if (selectedSeats.length >= 5) return alert("Max 5 seats allowed");
    el.classList.add("selected");
    selectedSeats.push({ seatId, name: "" });
  }
  updateNamesArea();
}

function updateNamesArea() {
  const area = document.getElementById("namesArea");
  area.innerHTML = selectedSeats.map((s, i) => `
    <div class="my-1">${s.seatId}: 
      <input placeholder="Name for seat" class="border p-1 w-64 text-black rounded bg-white" data-index="${i}" value="${s.name || ''}">
    </div>
  `).join("");
  area.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", e => selectedSeats[+e.target.dataset.index].name = e.target.value.trim());
  });
}

/* ---------- SUBMIT ---------- */
window.submitBooking = () => {
  const fullName = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (selectedSeats.length === 0 || selectedSeats.some(s => !s.name.trim())) return alert("Fill all names and select seats");
  localStorage.setItem("bookingFullName", fullName);
  localStorage.setItem("bookingPhone", phone);
  localStorage.setItem("selectedSeats", JSON.stringify(selectedSeats));

  onValue(ref(db, "bookings"), snap => {
    const data = snap.val();
    const bookedNow = selectedSeats.filter(s => Object.values(data || {}).some(b => b.seatId === s.seatId && (b.status === 'booked' || b.status === 'confirmed')));
    if (bookedNow.length > 0) return alert("Some seats just got booked. Refresh or choose others.");

    const dataRef = ref(db, "bookings");
    const promises = selectedSeats.map(seat => push(dataRef, {
      seatId: seat.seatId, screen: seat.seatId.split('-')[0], seat: seat.seatId.split('-')[1],
      name: seat.name, status: "booked", fullName, phone
    }));
    Promise.all(promises).then(() => window.location.href = "thankyou.html").catch(() => window.location.href = "error.html");
  }, { onlyOnce: true });
};

/* ---------- INIT ---------- */
renderScreens();
onValue(ref(db, "bookings"), snap => {
  const data = snap.val();
  if (!data) return;
  for (const b of Object.values(data)) {
    const el = document.querySelector(`[data-id='${b.seatId}']`);
    if (el) el.classList.add(b.status);
  }
});

/* Progressive GIF loader (prevents blank if GIF slow/missing) */
(function(){
  const img = new Image();
  img.onload  = () => document.body.classList.add('gif-bg');
  img.onerror = () => console.warn('BG.gif failed to load (path/case?) – using JPG fallback.');
  img.src = 'BG.gif?v=2';
})();

/* Auto-skip landing if coming from thankyou (index.html#book) or flag */
window.addEventListener("DOMContentLoaded", () => {
  if (location.hash === "#book" || sessionStorage.getItem("skipLanding") === "1") {
    skipToBooking();
  }
});
</script>
</body>
</html>
