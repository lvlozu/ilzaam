<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéüÔ∏è Loabin..? - Miladhoo Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Background blur overlay */
    #welcome::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url('BG.jpg') center/cover no-repeat;
      filter: blur(4px);
      opacity: 0.5;
      z-index: -1;
    }
    .seat {
      width: 34px; height: 34px; font-size: 12px;
      border-radius: 4px; line-height: 34px; text-align: center;
    }
    .seat.booked, .seat.confirmed { background-color: #9ca3af; color: white; cursor: not-allowed; }
    .seat.selected { background-color: #fb923c; color: white; }
    .clusterA .seat { border: 2px solid #60a5fa; }
    .clusterB .seat { border: 2px solid #f472b6; }
    .clusterC .seat { border: 2px solid #34d399; }
  </style>
</head>
<body class="bg-yellow-50 h-screen">

  <!-- Welcome Overlay -->
  <div id="welcome" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-black/50 z-50">
    <h1 class="text-3xl font-bold text-white drop-shadow-md mb-4">Welcome to Loabin..? Booking</h1>
    <p class="text-white max-w-md mb-6">Secure your tickets now! Please confirm your booking and make payment as instructed. Maximum 5 seats allowed per booking.</p>
    <button onclick="document.getElementById('welcome').classList.add('hidden')" class="bg-red-600 text-white px-6 py-3 rounded shadow-lg">Start Booking</button>
  </div>

  <!-- Original Booking Content -->
  <div class="p-4">
    <div id="step1">
      <h1 class="text-xl font-bold mb-2">üéüÔ∏è Loabin..? - Miladhoo Booking</h1>
      <p class="mb-2">
        ‚úÖ Ticket Price: 150/- per ticket<br>
        üü© Please make the payment after booking.<br>
        üì§ Booker is responsible for all seats booked. Max 5 seats allowed.
      </p>
      <input id="fullName" type="text" placeholder="Full Name" class="border p-2 w-full mb-2">
      <input id="phone" type="number" placeholder="Contact Number (7xxxxxxx or 9xxxxxxx)" class="border p-2 w-full mb-2">
      <button onclick="proceedToSeats()" class="bg-green-600 text-white px-4 py-2 rounded">Next</button>
    </div>

    <div id="step2" class="hidden">
      <h2 class="text-lg font-bold mb-2">Choose Your Seats (Max 5)</h2>
      <div class="grid md:grid-cols-3 grid-cols-1 gap-6">
        <div>
          <h3 class="text-blue-500 font-semibold mb-1 text-center">Screen A</h3>
          <div id="clusterA" class="clusterA"></div>
        </div>
        <div>
          <h3 class="text-pink-500 font-semibold mb-1 text-center">Screen B</h3>
          <div id="clusterB" class="clusterB"></div>
        </div>
        <div>
          <h3 class="text-green-500 font-semibold mb-1 text-center">Screen C</h3>
          <div id="clusterC" class="clusterC"></div>
        </div>
      </div>
      <div id="namesArea" class="mt-4"></div>
      <button onclick="submitBooking()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Submit Booking</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLb5aZcLr8L-l5ve3se3-nPNNA_6hU1VE",
  authDomain: "miladhoobooking.firebaseapp.com",
  databaseURL: "https://miladhoobooking-default-rtdb.firebaseio.com",
  projectId: "miladhoobooking",
  storageBucket: "miladhoobooking.appspot.com",
  messagingSenderId: "762620004750",
  appId: "1:762620004750:web:3bf9bbc843f54499673cdf"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const clusters = { clusterA: { rows: 9, cols: 9 }, clusterB: { rows: 10, cols: 10 }, clusterC: { rows: 9, cols: 9 } };
let selectedSeats = [];

window.proceedToSeats = () => {
  const name = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (!name || !/^([79])\d{6}$/.test(phone)) {
    alert("‚ùå Enter valid full name and contact number starting with 7 or 9");
    return;
  }
  document.getElementById("step1").classList.add("hidden");
  document.getElementById("step2").classList.remove("hidden");
};

function renderClusters() {
  for (const [clusterId, { rows, cols }] of Object.entries(clusters)) {
    const container = document.getElementById(clusterId);
    let seatCounter = 1;
    for (let r = 1; r <= rows; r++) {
      const row = document.createElement("div");
      row.className = `grid grid-cols-${cols} gap-1 mb-1`;
      const rowSeats = [];
      for (let c = 1; c <= cols; c++) {
        const trueCol = r % 2 === 0 ? cols - c + 1 : c;
        const seatNum = seatCounter++;
        const seatId = `${clusterId}-${seatNum}`;
        const el = document.createElement("div");
        el.className = "seat";
        el.textContent = seatNum;
        el.dataset.id = seatId;
        el.onclick = () => toggleSelect(seatId);
        rowSeats[trueCol - 1] = el;
      }
      rowSeats.forEach(seat => row.appendChild(seat));
      container.appendChild(row);
    }
  }
}
function toggleSelect(seatId) {
  const el = document.querySelector(`[data-id='${seatId}']`);
  if (!el || el.classList.contains("booked") || el.classList.contains("confirmed")) return;
  if (el.classList.contains("selected")) {
    el.classList.remove("selected");
    selectedSeats = selectedSeats.filter(s => s.seatId !== seatId);
  } else {
    if (selectedSeats.length >= 5) return alert("Max 5 seats allowed");
    el.classList.add("selected");
    selectedSeats.push({ seatId, name: "" });
  }
  updateNamesArea();
}
function updateNamesArea() {
  const area = document.getElementById("namesArea");
  area.innerHTML = selectedSeats.map((s, i) => `
    <div class="my-1">${s.seatId}: <input placeholder="Name for seat" class="border p-1 w-64" data-index="${i}" value="${s.name || ''}"></div>
  `).join("");
  area.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", e => selectedSeats[+e.target.dataset.index].name = e.target.value.trim());
  });
}
window.submitBooking = () => {
  const fullName = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (selectedSeats.length === 0 || selectedSeats.some(s => !s.name.trim())) return alert("Fill all names and select seats");
  localStorage.setItem("bookingFullName", fullName);
  localStorage.setItem("bookingPhone", phone);
  localStorage.setItem("selectedSeats", JSON.stringify(selectedSeats));

  onValue(ref(db, "bookings"), snap => {
    const data = snap.val();
    const bookedNow = selectedSeats.filter(s => Object.values(data || {}).some(b => b.seatId === s.seatId && (b.status === 'booked' || b.status === 'confirmed')));
    if (bookedNow.length > 0) return alert("Some seats just got booked. Refresh or choose others.");

    const dataRef = ref(db, "bookings");
    const promises = selectedSeats.map(seat => push(dataRef, {
      seatId: seat.seatId, cluster: seat.seatId.split('-')[0], seat: seat.seatId.split('-')[1],
      name: seat.name, status: "booked", fullName, phone
    }));
    Promise.all(promises).then(() => window.location.href = "thankyou.html").catch(() => window.location.href = "error.html");
  }, { onlyOnce: true });
};
renderClusters();
onValue(ref(db, "bookings"), snap => {
  const data = snap.val();
  if (!data) return;
  for (const b of Object.values(data)) {
    const el = document.querySelector(`[data-id='${b.seatId}']`);
    if (el) el.classList.add(b.status);
  }
});
</script>
</body>
</html>
