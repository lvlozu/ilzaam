<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Officer's Attendance Logs — BIZOLVE</title>
    <link rel="stylesheet" href="./styles.css">
    <style>
      :root { --err:#b71c1c; --ok:#1b5e20; --muted:#607d8b; }
      .banner { display:none; background: #ffebee; color:#b71c1c; padding:8px 12px; border-left:4px solid #b71c1c; font-size:12px; }
      .banner.show { display:block; }
      .banner code{ background:#ffcdd2; padding:1px 4px; border-radius:4px; }
      @media print { 
        @page { size: A4 portrait; } 
        body[data-page="attendance"]{ zoom:.72; } 
        .remarks-print{display:inline-block !important;} 
        textarea.remarks{display:none !important;} 
        .print-hide { display:none !important; }
      }
      textarea.remarks { height:22px; min-height:22px; max-height:22px; line-height:14px; white-space:nowrap; overflow-x:auto; overflow-y:hidden; resize:none; }
      .remarks-wrap { display:flex; align-items:center; gap:6px; }
      .remarks-print { display:none; font-size:10px; }
      .small { font-size:10px; }
      .compactRow .pad-sm { padding: 2px !important; }
      .compactRow .text-xs { font-size: 9px !important; }
      .editable { cursor:text; border-bottom:1px dotted transparent; }
      .editable:hover { border-color:#94a3b8; }
      input.inline-edit {
        font-size: 12px; padding: 1px 4px; border:1px solid #cbd5e1; border-radius:6px;
        width: 140px; max-width: 160px;
      }
    </style>
  </head>
  <body data-page="attendance">
    <div id="banner" class="banner"></div>
    <div id="app"></div>

    <script type="module">
      // Resilient loader: try imports; if they fail (file:// or missing), fall back with stubs
      let db, SITE_ID, daysInMonth, formatMonthYear, isWeekendHoliday, staffName, computeShiftsForDate;
      const banner = document.getElementById('banner');
      function showError(msg){
        banner.innerHTML = msg; banner.classList.add('show');
      }

      async function loadDeps(){
        try {
          const init = await import('./firebase-init.js');
          db = init.db;
        } catch (e) {
          showError('Could not load <code>firebase-init.js</code>. Running in offline mode. Serve over HTTP (e.g. GitHub Pages) instead of <code>file://</code>.');
        }
        try {
          const s = await import('./shared.js');
          SITE_ID = s.SITE_ID; daysInMonth = s.daysInMonth; formatMonthYear = s.formatMonthYear; 
          isWeekendHoliday = s.isWeekendHoliday; staffName = s.staffName; computeShiftsForDate = s.computeShiftsForDate;
        } catch (e) {
          // Provide minimal fallbacks so UI renders
          showError((banner.innerHTML? banner.innerHTML+'<br>' : '') + 'Could not load <code>shared.js</code>. Using default rules for demo rendering.');
          SITE_ID = 'demo-site';
          daysInMonth = (y,m)=> new Date(y, m+1, 0).getDate();
          formatMonthYear = (y,m)=> new Date(y,m,1).toLocaleString('en',{month:'long',year:'numeric'});
          isWeekendHoliday = (d)=> [5,6].includes(d.getDay());
          staffName = (id)=> id==='ibrahim'?'I. Naseer': id==='saeedha'?'Saeedhaa A.K' : id==='rizaana'?'Rizaana A.': '';
          computeShiftsForDate = (date, sch, ov)=> {
            const weekend = isWeekendHoliday(date);
            const forcedPH = ov===1, forcedSH = ov===2;
            if (forcedPH || (!forcedSH && weekend)) {
              return [
                { time:'23:00–07:00', staffId:'ibrahim' },
                { time:'15:00–23:00', staffId:'saeedha' },
                { time:'07:00–15:00', staffId:'rizaana' },
              ];
            }
            if (forcedSH || sch) {
              return [
                { time:'00:00–08:00', staffId:'ibrahim' },
                { time:'16:00–00:00', staffId:'saeedha' },
                { time:'14:00–16:00', staffId:'rizaana' },
              ];
            }
            return [
              { time:'23:00–07:00', staffId:'ibrahim' },
              { time:'15:00–23:00', staffId:'saeedha' },
              { grey:true },
            ];
          };
        }
      }

      // Utilities that don't depend on shared.js
      function startMinutes(time){ if(!time) return Infinity; const [a,b]=time.split('–'); const [sh,sm]=a.split(':'); const [eh,em]=b.split(':'); const s=+sh*60+ +sm; const e=+eh*60+ +em; if (s<=e) return s; if (e===0) return s; return 0; }
      function isPastDay(date){
        const today = new Date(); const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const d0 = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        return d0.getTime() < t0.getTime();
      }
      function isTodayDay(date){
        const today = new Date(); return date.getFullYear()===today.getFullYear() && date.getMonth()===today.getMonth() && date.getDate()===today.getDate();
      }
      const shortName = (full)=> full;

      async function main(){
        await loadDeps();
        const { doc, onSnapshot, setDoc } = db ? await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js') : { doc:()=>{}, onSnapshot:()=>{}, setDoc:()=>{} };

        const root = document.getElementById('app');
        const now = new Date();
        let year = now.getFullYear();
        let month = now.getMonth();
        const state = { overrides:{}, schoolMap:{}, att:{} };
        let unsubRoster = ()=>{}; let unsubAtt = ()=>{};
        let suppressUntil = 0;

        function attendanceRef(year, month){ const ym = `${year}${String(month+1).padStart(2,'0')}`; return doc(db, 'attendance', `${SITE_ID}_${ym}`); }
        function rosterRef(year, month){ const ym = `${year}${String(month+1).padStart(2,'0')}`; return doc(db, 'rosters', `${SITE_ID}_${ym}`); }

        function header(){
          const wrap = document.createElement('div'); wrap.className='pad';
          const bar = document.createElement('div'); bar.style.display='grid'; bar.style.gridTemplateColumns='1fr 1fr 1fr'; bar.style.alignItems='center';
          const left = document.createElement('div'); left.className='text-sm bold'; left.innerHTML='<div style="font-size:26px;font-weight:700;letter-spacing:1px;color:#004d40;text-shadow:1px 1px 2px rgba(0,0,0,0.2);font-family:Cinzel,serif">BIZOLVE</div><div style="font-size:11px;color:#00796b;font-weight:500;margin-top:-3px;">Security Services Division</div>';
          const center = document.createElement('div'); center.style.textAlign='center'; center.innerHTML = '<div class="text-xl">Security Officer\'s Attendance Logs</div><div class="text-sm">for Hidhaya School / N. Miladhoo</div>';
          const right = document.createElement('div'); right.className='text-sm'; right.style.textAlign='right'; right.textContent = formatMonthYear(year, month);
          bar.append(left, center, right); wrap.appendChild(bar); return wrap;
        }

        function controls(){
          const wrap = document.createElement('div'); wrap.className='pad print-hide';
          const monthSel = document.createElement('select'); monthSel.className='select';
          const yearSel = document.createElement('select'); yearSel.className='select';
          for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent = new Date(2025,i,1).toLocaleString('en',{month:'short'}); if(i===month) o.selected=true; monthSel.appendChild(o); }
          const baseYear = new Date().getFullYear(); for(let i=-2;i<=3;i++){ const y=baseYear+i; const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); if(y===year) o.selected=true; yearSel.appendChild(o); }
          const prevBtn = document.createElement('button'); prevBtn.className='btn'; prevBtn.textContent='Prev';
          const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='Next';
          const printBtn = document.createElement('button'); printBtn.className='btn'; printBtn.textContent='Print / Save PDF'; printBtn.onclick = ()=>window.print();
          prevBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()-1); year=d.getFullYear(); month=d.getMonth(); resubscribe(); };
          nextBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()+1); year=d.getFullYear(); month=d.getMonth(); resubscribe(); };
          monthSel.onchange = ()=>{ month = parseInt(monthSel.value); resubscribe(); };
          yearSel.onchange = ()=>{ year = parseInt(yearSel.value); resubscribe(); };
          wrap.append(prevBtn, nextBtn, monthSel, yearSel, printBtn);
          return wrap;
        }

        function chipSet(el, status){
          el.dataset.status = (status===undefined? '' : status);
          el.className = 'badge ' + (status==='present' ? 'present' : (status==='absent' ? 'absent' : ''));
          el.innerHTML = (status==='present') ? '✓&nbsp;Present' : (status==='absent' ? '✗&nbsp;Absent' : '—');
        }
        function makeChip(status){
          const span = document.createElement('span'); chipSet(span, status); return span;
        }

        function build(len){
          const wrap = document.createElement('div'); wrap.className='pad';
          const card = document.createElement('div'); card.className='card'; wrap.appendChild(card);

          const head = document.createElement('div');
          head.className='pad-sm bold text-xs header-att cols-att';
          head.innerHTML = '<div>Date</div><div>Day</div><div>Shift 1</div><div>Shift 2</div><div>Shift 3</div><div>Incidents &amp; Important Events</div>';
          card.appendChild(head);

          const today = new Date(); const nowMin = today.getHours()*60 + today.getMinutes();

          for(let d=1; d<=len; d++){
            const date = new Date(year, month, d);
            const ov = state.overrides[String(d)] ?? 0;
            const sch = !!state.schoolMap[String(d)];
            const shifts = computeShiftsForDate(date, sch, ov);
            const row = document.createElement('div');
            const weekend = isWeekendHoliday(date); const isHol = weekend || ov===1; const isSchool = !isHol && (ov===2 || sch);
            row.className = (isHol ? 'holiday' : (isSchool ? 'school' : ''));
            row.classList.add('cols-att'); row.style.borderTop='1px solid #e5e7eb';

            const dCell = document.createElement('div'); dCell.className='pad-sm bold';
            const dd = String(d).padStart(2,'0');
            const monthFull = new Date(year, month, 1).toLocaleString('en', { month: 'long' });
            dCell.innerHTML = dd + ' <span class="small">'+monthFull+'</span>';
            const wCell = document.createElement('div'); wCell.className='pad-sm muted small'; wCell.textContent = new Date(year,month,d).toLocaleString('en',{ weekday:'long'});
            row.append(dCell, wCell);

            const record = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };

            shifts.forEach((s, idx)=>{
              const cell = document.createElement('div'); cell.className='pad-sm';
              if (s.grey){ cell.classList.add('noduty'); row.appendChild(cell); return; }
              const saved = (record.rows[idx] || {});
              const baseName = saved.customName || (staffName(saved.staffId || s.staffId));
              let status = saved.status;
              if (!status){
                if (isPastDay(date)) status = 'present';
                else if (isTodayDay(date)){
                  const start = startMinutes(s.time);
                  if (start!==Infinity && nowMin>=start) status='present';
                }
              }

              const line = document.createElement('div'); line.className='inline';
              const t1 = document.createElement('div'); t1.className='text-xs bold'; t1.textContent=s.time;

              // Editable officer name
              const nameWrap = document.createElement('div'); nameWrap.style.display='flex'; nameWrap.style.alignItems='center'; nameWrap.style.gap='6px';
              const nameText = document.createElement('div'); nameText.className='text-xs editable'; nameText.textContent = baseName; nameText.title='Click to edit officer name';
              const input = document.createElement('input'); input.className='inline-edit print-hide'; input.type='text'; input.style.display='none'; input.value = baseName;

              function commitName(){
                const val = input.value.trim();
                const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
                const rowObj = cur.rows[idx] || {};
                const nextRow = { ...rowObj, customName: val };
                const rows = cur.rows.map((r,i)=> i===idx ? nextRow : r);
                const next = { ...state.att, [String(d)]: { ...cur, rows } };
                state.att = next;
                nameText.textContent = val || baseName;
                input.style.display='none'; nameText.style.display='inline';
                suppressUntil = Date.now() + 500;
                if (db) setDoc(attendanceRef(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
              }

              nameText.onclick = ()=>{
                input.value = nameText.textContent;
                nameText.style.display='none'; input.style.display='inline-block'; input.focus(); input.select();
              };
              input.addEventListener('keydown', (e)=>{
                if (e.key==='Enter'){ e.preventDefault(); commitName(); }
                if (e.key==='Escape'){ input.style.display='none'; nameText.style.display='inline'; }
              });
              input.addEventListener('blur', commitName);
              nameWrap.append(nameText, input);

              const stamp = makeChip(status);
              stamp.onclick = ()=>{
                const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
                const old = cur.rows[idx] || {};
                let nextStatus;
                if (old.status === 'present') nextStatus = 'absent';
                else if (old.status === 'absent') nextStatus = undefined;
                else nextStatus = 'present';
                const rows = cur.rows.map((r,i)=> i===idx ? { ...r, status: nextStatus } : r);
                const next = { ...state.att, [String(d)]: { ...cur, rows } };
                state.att = next;
                chipSet(stamp, nextStatus);
                suppressUntil = Date.now() + 400;
                if (db) setDoc(attendanceRef(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
              };

              line.append(t1, nameWrap, stamp);
              cell.appendChild(line);
              row.appendChild(cell);
            });

            // Remarks
            const remarks = document.createElement('div'); remarks.className='pad-sm';
            const wrapR = document.createElement('div'); wrapR.className='remarks-wrap';
            const txt = document.createElement('textarea'); txt.className='remarks'; txt.placeholder='-';
            let initial = (record.dayRemark && record.dayRemark.trim()!=='' ? record.dayRemark : '-');
            txt.value = initial;
            const mirror = document.createElement('span'); mirror.className='remarks-print'; mirror.textContent = initial;
            txt.addEventListener('keydown', (e)=>{ if (e.key==='Enter') { e.preventDefault(); e.stopPropagation(); } });
            txt.addEventListener('focus', ()=>{ if (txt.value.trim()==='-') { txt.value=''; } });
            function persistRemark(){
              const val = txt.value.trim()==='' ? '-' : txt.value;
              mirror.textContent = val;
              const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
              const next = { ...state.att, [String(d)]: { ...cur, dayRemark: val } };
              state.att = next;
              if (val==='-') row.classList.add('compactRow'); else row.classList.remove('compactRow');
              suppressUntil = Date.now() + 400;
              if (db) setDoc(attendanceRef(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
            }
            if (initial==='-') row.classList.add('compactRow');
            txt.addEventListener('input', persistRemark);
            txt.addEventListener('blur', persistRemark);
            remarks.appendChild(wrapR); wrapR.append(txt, mirror);
            row.appendChild(remarks);
            card.appendChild(row);
          }

          window.onbeforeprint = ()=>{
            document.querySelectorAll('textarea.remarks').forEach(el=>{
              const val = el.value.trim()==='' ? '-' : el.value;
              const sib = el.parentElement?.querySelector('.remarks-print'); if (sib) sib.textContent = val;
            });
          };

          return wrap;
        }

        function resubscribe(){
          const nav = document.createElement('div'); nav.className='mbar print-hide'; nav.innerHTML = '<a class="btn" href="./WC.html">← Back to WC</a><div class="grow"></div>';
          root.innerHTML=''; root.appendChild(nav); root.appendChild(header()); root.appendChild(controls());
          const len = daysInMonth(year, month);

          if (db){
            const { onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js');
            const rRef = rosterRef(year, month);
            const aRef = attendanceRef(year, month);
            unsubRoster(); unsubAtt();
            unsubRoster = onSnapshot(rRef, snap=>{
              const d = snap.data() || {};
              state.overrides = d.overrides || {};
              state.schoolMap = d.schoolMap || {};
              if (Date.now() < suppressUntil) return;
              const old = document.getElementById('table-wrap'); if (old) old.remove();
              const tbl = build(len); tbl.id='table-wrap'; root.appendChild(tbl);
              appendFooter();
            }, ()=>{ state.overrides = {}; state.schoolMap = {}; });
            unsubAtt = onSnapshot(aRef, snap=>{
              const data = snap.data() || {}; state.att = data.rows || {};
              if (Date.now() < suppressUntil) return;
              const old = document.getElementById('table-wrap'); if (old) old.remove();
              const tbl = build(len); tbl.id='table-wrap'; root.appendChild(tbl);
              appendFooter();
            }, ()=>{ state.att = {}; });
          } else {
            // Offline fallback: render with empty state so it's not blank
            const old = document.getElementById('table-wrap'); if (old) old.remove();
            const tbl = build(len); tbl.id='table-wrap'; root.appendChild(tbl);
            appendFooter();
          }
        }

        function appendFooter(){
          let foot = document.getElementById('foot'); if (foot) foot.remove();
          foot = document.createElement('div'); foot.id='foot'; foot.className='pad'; foot.style.background='#f1f8e9'; foot.style.textAlign='center';
          foot.innerHTML = '<div>Supervised &amp; Managed by Hassan Irfan Mohamed</div><div class="bold" style="margin-top:2px;">BIZOLVE - Owner</div><div style="margin-top:2px;">contact: 7981238</div>';
          document.getElementById('app').appendChild(foot);
        }

        resubscribe();
      }

      main();
    </script>
  </body>
</html>
