<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Logs — BIZOLVE</title>
    <link rel="stylesheet" href="./styles.css">
    <style>@media print { @page { size: A4 portrait; } body[data-page="attendance"]{ zoom:.72; } }</style>
    <script type="module">
      import { db } from './firebase-init.js';
      import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import { SITE_ID, daysInMonth, formatMonthYear, pad, weekdayShort, isWeekendHoliday, monthShort, staffName, computeShiftsForDate } from './shared.js';

      function attendanceRef(year, month){ const ym = `${year}${String(month+1).padStart(2,'0')}`; return doc(db, 'attendance', `${SITE_ID}_${ym}`); }
      function rosterRef(year, month){ const ym = `${year}${String(month+1).padStart(2,'0')}`; return doc(db, 'rosters', `${SITE_ID}_${ym}`); }

      const shortName = (full)=> full?.startsWith('Ibrahim') ? 'I. Naseer'
                           : full?.startsWith('Saeedhaa') ? 'Saeedhaa A.K'
                           : full?.startsWith('Riza') ? 'Rizaana A.'
                           : (full||'');

      function startMinutes(time){ if(!time) return Infinity; const [a,b]=time.split('–'); const [sh,sm]=a.split(':'); const [eh,em]=b.split(':'); const s=+sh*60+ +sm; const e=+eh*60+ +em; if (s<=e) return s; if (e===0) return s; return 0; }
      function isPastDay(date){
        const today = new Date(); const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const d0 = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        return d0.getTime() < t0.getTime();
      }
      function isTodayDay(date){
        const today = new Date(); return date.getFullYear()===today.getFullYear() && date.getMonth()===today.getMonth() && date.getDate()===today.getDate();
      }

      function render(){
        const root = document.getElementById('app');
        const now = new Date();
        let year = parseInt(sessionStorage.getItem('yr') || now.getFullYear());
        let month = parseInt(sessionStorage.getItem('mo') || now.getMonth());
        const state = { overrides:{}, schoolMap:{}, att:{} };
        let unsubRoster = ()=>{}; let unsubAtt = ()=>{};

        function header(){
          const wrap = document.createElement('div'); wrap.className='pad';
          const bar = document.createElement('div'); bar.style.display='grid'; bar.style.gridTemplateColumns='1fr 1fr 1fr'; bar.style.alignItems='center';
          const left = document.createElement('div'); left.className='text-sm bold'; left.textContent='BIZOLVE';
          const center = document.createElement('div'); center.style.textAlign='center'; center.innerHTML = '<div class="text-xl">Attendance Logs</div><div class="text-sm">for Hidhaya School / N. Miladhoo</div>';
          const right = document.createElement('div'); right.className='text-sm'; right.style.textAlign='right'; right.textContent = formatMonthYear(year, month);
          bar.append(left, center, right); wrap.appendChild(bar); return wrap;
        }

        function controls(){
          const wrap = document.createElement('div'); wrap.className='pad print-hide';
          const monthSel = document.createElement('select'); monthSel.className='select';
          const yearSel = document.createElement('select'); yearSel.className='select';
          for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent = new Date(2025,i,1).toLocaleString('en',{month:'short'}); if(i===month) o.selected=true; monthSel.appendChild(o); }
          const baseYear = new Date().getFullYear(); for(let i=-2;i<=3;i++){ const y=baseYear+i; const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); if(y===year) o.selected=true; yearSel.appendChild(o); }
          const prevBtn = document.createElement('button'); prevBtn.className='btn'; prevBtn.textContent='Prev';
          const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='Next';
          const printBtn = document.createElement('button'); printBtn.className='btn'; printBtn.textContent='Print / Save PDF'; printBtn.onclick = ()=>window.print();
          prevBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()-1); year=d.getFullYear(); month=d.getMonth(); resubscribe(); };
          nextBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()+1); year=d.getFullYear(); month=d.getMonth(); resubscribe(); };
          monthSel.onchange = ()=>{ month = parseInt(monthSel.value); resubscribe(); };
          yearSel.onchange = ()=>{ year = parseInt(yearSel.value); resubscribe(); };
          wrap.append(prevBtn, nextBtn, monthSel, yearSel, printBtn);
          return wrap;
        }

        function chip(status){
          const span = document.createElement('span');
          span.className = 'badge ' + (status==='present' ? 'present' : (status==='absent' ? 'absent' : ''));
          span.innerHTML = (status==='present') ? '✓&nbsp;Present' : (status==='absent' ? '✗&nbsp;Absent' : '—');
          return span;
        }

        function build(len){
          const wrap = document.createElement('div'); wrap.className='pad';
          const card = document.createElement('div'); card.className='card'; wrap.appendChild(card);

          const head = document.createElement('div');
          head.className='pad-sm bold text-xs header-att cols-att';
          head.innerHTML = '<div>Day</div><div>Wk</div><div>S1</div><div>S2</div><div>S3</div><div>Remarks</div>';
          card.appendChild(head);

          const today = new Date(); const nowMin = today.getHours()*60 + today.getMinutes();

          for(let d=1; d<=len; d++){
            const date = new Date(year, month, d);
            const ov = state.overrides[String(d)] ?? 0;
            const sch = !!state.schoolMap[String(d)];
            const shifts = computeShiftsForDate(date, sch, ov);
            const row = document.createElement('div');
            const weekend = isWeekendHoliday(date); const isHol = weekend || ov===1; const isSchool = !isHol && (ov===2 || sch);
            row.className = (isHol ? 'holiday' : (isSchool ? 'school' : ''));
            row.classList.add('cols-att'); row.style.borderTop='1px solid #e5e7eb';

            const dCell = document.createElement('div'); dCell.className='pad-sm bold'; dCell.textContent = f`${str(d).zfill(2)} ${monthShort(year,month)}`;
            const wCell = document.createElement('div'); wCell.className='pad-sm muted'; wCell.textContent = weekdayShort(date.getDay());
            row.append(dCell, wCell);

            const record = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };

            shifts.forEach((s, idx)=>{
              const cell = document.createElement('div'); cell.className='pad-sm';
              if (s.grey){ cell.classList.add('noduty'); row.appendChild(cell); return; }
              const rec = (record.rows[idx] || {});
              let status = rec.status;
              if (!status){
                if (isPastDay(date)) status = 'present';
                else if (isTodayDay(date)){
                  const start = startMinutes(s.time);
                  if (start!==Infinity && nowMin>=start) status='present';
                }
              }
              const line = document.createElement('div'); line.className='inline';
              const t1 = document.createElement('div'); t1.className='text-xs bold'; t1.textContent=s.time;
              const t2 = document.createElement('div'); t2.className='text-xs'; t2.textContent = shortName(staffName(s.staffId));
              const stamp = chip(status); stamp.style.cursor='pointer';
              stamp.onclick = ()=>{
                const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
                const old = cur.rows[idx] || {};
                const nextStatus = old.status==='present' ? 'absent' : (old.status==='absent' ? undefined : 'present');
                const rows = cur.rows.map((r,i)=> i===idx ? { ...r, status: nextStatus } : r);
                const next = { ...state.att, [String(d)]: { ...cur, rows } };
                state.att = next;
                setDoc(attendanceRef(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
                stamp.replaceWith(chip(nextStatus));
              };
              line.append(t1, t2, stamp);
              cell.appendChild(line);
              row.appendChild(cell);
            });

            const remarks = document.createElement('div'); remarks.className='pad-sm';
            const txt = document.createElement('textarea'); txt.placeholder='...'; txt.style.minHeight='24px';
            txt.value = record.dayRemark || '';
            txt.oninput = ()=>{
              const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
              const next = { ...state.att, [String(d)]: { ...cur, dayRemark: txt.value } };
              state.att = next;
              setDoc(attendanceRef(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
            };
            remarks.appendChild(txt);
            row.appendChild(remarks);
            card.appendChild(row);
          }

          return wrap;
        }

        function resubscribe(){
          root.innerHTML='';
          const len = daysInMonth(year, month);
          const nav = document.createElement('div'); nav.className='mbar print-hide'; nav.innerHTML = '<a class="btn" href="./WC.html">← Back to WC</a><div class="grow"></div>'; root.appendChild(nav);
          root.appendChild(header());
          root.appendChild(controls());

          const rRef = rosterRef(year, month);
          unsubRoster(); unsubAtt();
          unsubRoster = onSnapshot(rRef, snap=>{
            const d = snap.data() || {};
            state.overrides = d.overrides || {};
            state.schoolMap = d.schoolMap || {};
            const old = document.getElementById('table-wrap'); if (old) old.remove();
            const tbl = build(len); tbl.id='table-wrap'; root.appendChild(tbl);
            let foot = document.getElementById('foot'); if (foot) foot.remove();
            foot = document.createElement('div'); foot.id='foot'; foot.className='pad center text-xs'; foot.style.background='#f1f8e9'; foot.textContent = 'Supervised & Managed by Hassan Irfan Mohamed (BIZOLVE) — Electronic Signature Verified';
            root.appendChild(foot);
          }, ()=>{ state.overrides = {}; state.schoolMap = {}; });

          const aRef = attendanceRef(year, month);
          unsubAtt = onSnapshot(aRef, snap=>{
            const data = snap.data() || {}; state.att = data.rows || {};
            const old = document.getElementById('table-wrap'); if (old) old.remove();
            const tbl = build(len); tbl.id='table-wrap'; root.appendChild(tbl);
            let foot = document.getElementById('foot'); if (foot) foot.remove();
            foot = document.createElement('div'); foot.id='foot'; foot.className='pad center text-xs'; foot.style.background='#f1f8e9'; foot.textContent = 'Supervised & Managed by Hassan Irfan Mohamed (BIZOLVE) — Electronic Signature Verified';
            root.appendChild(foot);
          }, ()=>{ state.att = {}; });
        }

        resubscribe();
      }

      window.addEventListener('DOMContentLoaded', ()=>{
        document.body.setAttribute('data-page','attendance');
        render();
      });
    </script>
  </head>
  <body data-page="attendance">
    <div id="app"></div>
  </body>
</html>
