<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Logs — BIZOLVE</title>
    <link rel="stylesheet" href="./styles.css">
    <script type="module">
      import { app, db } from './firebase-init.js';
      import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import { PROVIDER, CLIENT, OWNER_LINE, SITE_ID, STAFF, daysInMonth, formatMonthYear, pad, weekdayShort, isWeekendHoliday, monthShort, staffName } from './shared.js';

      function attendanceDoc(year, month){
        const ym = `${year}${String(month+1).padStart(2,'0')}`;
        return doc(db, 'attendance', `${SITE_ID}_${ym}`);
      }
      function rosterDoc(year, month){
        const ym = `${year}${String(month+1).padStart(2,'0')}`;
        return doc(db, 'rosters', `${SITE_ID}_${ym}`);
      }

      function parseHHMM(h){ const [hh,mm]=h.split(':'); return (+hh)*60+(+mm); }
      function onDayStartMinute(time){ if(!time) return Infinity; const [a,b]=time.split('–'); const s=parseHHMM(a); const e=parseHHMM(b); if(s<=e) return s; if(e===0) return s; return 0; }

      function computeShiftsForDate(date, schoolHoliday, override){
        const d = date.getDay(); const weekendHol = (d===5 || d===6);
        const forcedHoliday = override===1; const forcedSchool = override===2;
        if (forcedHoliday || (!forcedSchool && !forcedHoliday && weekendHol)){
          return [
            { label:'Shift 1', time:'23:00–07:00', staffId: STAFF.ibrahim.id },
            { label:'Shift 2', time:'07:00–15:00', staffId: STAFF.rizaana.id },
            { label:'Shift 3', time:'15:00–23:00', staffId: STAFF.saeedha.id },
          ];
        }
        if (forcedSchool || schoolHoliday){
          return [
            { label:'Shift 1', time:'00:00–08:00', staffId: STAFF.ibrahim.id },
            { label:'Shift 2', time:'14:00–16:00', staffId: STAFF.rizaana.id },
            { label:'Shift 3', time:'16:00–00:00', staffId: STAFF.saeedha.id },
          ];
        }
        return [
          { label:'Shift 1', time:'23:00–07:00', staffId: STAFF.ibrahim.id },
          { label:'Shift 2', grey:true },
          { label:'Shift 3', time:'15:00–23:00', staffId: STAFF.saeedha.id },
        ];
      }

      function render(){
        const root = document.getElementById('app');
        root.innerHTML = '';

        const now = new Date();
        let year = parseInt(sessionStorage.getItem('yr') || now.getFullYear());
        let month = parseInt(sessionStorage.getItem('mo') || now.getMonth());
        const state = { overrides:{}, schoolMap:{}, att:{} };

        function saveYM(){ sessionStorage.setItem('yr', String(year)); sessionStorage.setItem('mo', String(month)); }

        function header(){
          const band = document.createElement('div');
          band.className='bar pad center';
          const len = daysInMonth(year, month);
          const label = formatMonthYear(year, month);
          band.innerHTML = [
            `<div class="text-xl">BIZOLVE</div>`,
            `<div class="text-lg">Attendance Logs</div>`,
            `<div class="text-sm">Month: ${label} (01 – ${pad(len)})</div>`,
            `<div class="text-sm">For Hidhaya School / N. Miladhoo</div>`
          ].join('');
          return band;
        }

        function table(){
          const len = daysInMonth(year, month);
          const wrap = document.createElement('div'); wrap.className='pad';
          const card = document.createElement('div'); card.className='card'; wrap.appendChild(card);

          const head = document.createElement('div');
          head.className='pad-sm bold text-xs';
          head.style.background = '#e3f2fd';
          head.style.display = 'grid';
          head.style.gridTemplateColumns = '1fr 1fr 2fr 2fr 2fr 2fr';
          head.innerHTML = '<div>Day</div><div>Weekday</div><div>Shift 1</div><div>Shift 2</div><div>Shift 3</div><div>Incidents & Important Remarks</div>';
          card.appendChild(head);

          for(let d=1; d<=len; d++){
            const date = new Date(year, month, d);
            const ov = state.overrides[String(d)] ?? 0;
            const sch = !!state.schoolMap[String(d)];
            const shifts = computeShiftsForDate(date, sch, ov);
            const row = document.createElement('div');
            const weekend = isWeekendHoliday(date); const isHol = weekend || ov===1; const isSchool = !isHol && (ov===2 || sch);
            row.className = (isHol ? 'holiday' : (isSchool ? 'school' : ''));
            row.style.display='grid'; row.style.gridTemplateColumns='1fr 1fr 2fr 2fr 2fr 2fr'; row.style.borderTop='1px solid #e5e7eb';

            const dCell = document.createElement('div'); dCell.className='pad-sm bold'; dCell.textContent = `${pad(d)} ${monthShort(year,month)}`;
            const wCell = document.createElement('div'); wCell.className='pad-sm muted'; wCell.textContent = weekdayShort(date.getDay());
            row.append(dCell, wCell);

            const record = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };

            function stampEl(status){
              const span = document.createElement('span'); span.className='stamp';
              if (status==='present'){ span.classList.add('present'); span.textContent='PRESENT'; }
              else if (status==='absent'){ span.classList.add('absent'); span.textContent='ABSENT'; }
              else { span.textContent='—'; }
              return span;
            }

            const today = new Date(); const sameMonth = (today.getFullYear()===year && today.getMonth()===month);
            const todayD = today.getDate(); const nowMin = today.getHours()*60 + today.getMinutes();

            shifts.forEach((s, idx)=>{
              const cell = document.createElement('div'); cell.className='pad-sm';
              if (s.grey){ cell.classList.add('noduty'); row.appendChild(cell); return; }
              const rec = (record.rows[idx] || {});
              let status = rec.status;
              if (!status){
                if (!sameMonth || d < todayD) status = 'present';
                else if (sameMonth && d===todayD){
                  const start = onDayStartMinute(s.time);
                  if (start!==Infinity && nowMin>=start) status='present';
                }
              }
              const t1 = document.createElement('div'); t1.className='text-xs bold'; t1.textContent=s.time;
              const t2 = document.createElement('div'); t2.className='text-xs'; t2.textContent = staffName(s.staffId);
              const btn = document.createElement('button'); btn.className='btn'; btn.appendChild(stampEl(status));
              btn.onclick = ()=>{
                const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
                const old = cur.rows[idx] || {};
                const nextStatus = old.status==='present' ? 'absent' : (old.status==='absent' ? undefined : 'present');
                const rows = cur.rows.map((r,i)=> i===idx ? { ...r, status: nextStatus } : r);
                const next = { ...state.att, [String(d)]: { ...cur, rows } };
                state.att = next;
                setDoc(attendanceDoc(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
                render();
              };
              cell.append(t1,t2,btn);
              row.appendChild(cell);
            });

            const remarks = document.createElement('div'); remarks.className='pad-sm';
            const txt = document.createElement('textarea'); txt.placeholder = 'Record incidents / important remarks';
            txt.value = record.dayRemark || '';
            txt.oninput = (e)=>{
              const cur = state.att[String(d)] || { rows:[{},{},{}], dayRemark:'' };
              const next = { ...state.att, [String(d)]: { ...cur, dayRemark: txt.value } };
              state.att = next;
              setDoc(attendanceDoc(year,month), { siteId: SITE_ID, year, month, rows: next }, { merge:true });
            };
            remarks.appendChild(txt);
            row.appendChild(remarks);
            card.appendChild(row);
          }

          return wrap;
        }

        function nav(){
          const bar = document.createElement('div');
          bar.className='mbar';
          const back = document.createElement('a'); back.className='btn'; back.href='./WC.html'; back.textContent='← Back to WC';
          const grow = document.createElement('div'); grow.className='grow';
          const toRoster = document.createElement('a'); toRoster.className='btn'; toRoster.href='./roster.html'; toRoster.textContent='Go to Roster';
          bar.append(back, grow, toRoster);
          return bar;
        }

        function controls(){
          const wrap = document.createElement('div'); wrap.className='pad controls';
          const prevBtn = document.createElement('button'); prevBtn.className='btn'; prevBtn.textContent='Prev';
          const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='Next';
          const lab = document.createElement('div'); lab.className='bold';
          const setLab = ()=> lab.textContent = formatMonthYear(year, month);
          setLab();
          prevBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()-1); year=d.getFullYear(); month=d.getMonth(); saveYM(); resubscribe(); };
          nextBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()+1); year=d.getFullYear(); month=d.getMonth(); saveYM(); resubscribe(); };
          wrap.append(prevBtn, lab, nextBtn);
          return { wrap, setLab };
        }

        let unsubRoster = ()=>{}; let unsubAtt = ()=>{};
        function resubscribe(){
          unsubRoster(); unsubAtt();
          const hdr = header();
          const navBar = nav();
          const ctrl = controls();
          root.innerHTML='';
          root.append(navBar, hdr, ctrl.wrap);

          const rRef = rosterDoc(year, month);
          unsubRoster = onSnapshot(rRef, snap=>{
            const d = snap.data() || {};
            state.overrides = d.overrides || {};
            state.schoolMap = d.schoolMap || {};
            ctrl.setLab();
            const tbl = table();
            // Replace existing table/card section
            const old = document.getElementById('table-wrap');
            if (old) old.remove();
            tbl.id = 'table-wrap';
            root.appendChild(tbl);
            const foot = document.createElement('div'); foot.className='pad center text-xs'; foot.style.background='#f1f8e9'; foot.textContent = OWNER_LINE;
            root.appendChild(foot);
          });

          const aRef = attendanceDoc(year, month);
          unsubAtt = onSnapshot(aRef, snap=>{
            const data = snap.data() || {}; state.att = data.rows || {};
            // table will be re-rendered when roster snapshot also fires or next month switch
          }, ()=>{ state.att = {}; });
        }

        resubscribe();
      }

      window.addEventListener('DOMContentLoaded', render);
    </script>
  </head>
  <body>
    <div class="mbar">
      <a class="btn" href="./WC.html">← Back to WC</a>
      <div class="grow"></div>
      <a class="btn" href="./roster.html">Go to Roster</a>
    </div>
    <div id="app"></div>
  </body>
</html>
