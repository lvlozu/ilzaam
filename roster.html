<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duty Roster — BIZOLVE</title>
    <link rel="stylesheet" href="./styles.css">
    <style>@media print { @page { size: A4 landscape; } }</style>
    <script type="module">
      import { db } from './firebase-init.js';
      import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
      import { SITE_ID, daysInMonth, startOfMonthWeekday, formatMonthYear, monthShort, isWeekendHoliday, staffName, displayStartMinute, computeShiftsForDate } from './shared.js';

      function rosterRef(year, month){
        const ym = `${year}${String(month+1).padStart(2,'0')}`;
        return doc(db, 'rosters', `${SITE_ID}_${ym}`);
      }
      const shortName = (full)=> full?.startsWith('Ibrahim') ? 'I. Naseer'
                           : full?.startsWith('Saeedhaa') ? 'Saeedhaa A.K'
                           : full?.startsWith('Riza') ? 'Rizaana A.'
                           : (full||'');

      function render(){
        const root = document.getElementById('app');
        const now = new Date();
        let year = parseInt(sessionStorage.getItem('yr') || now.getFullYear());
        let month = parseInt(sessionStorage.getItem('mo') || now.getMonth());
        const state = { overrides:{}, schoolMap:{} };
        let unsubscribe = ()=>{};

        function header(){
          const wrap = document.createElement('div'); wrap.className='pad';
          const bar = document.createElement('div'); bar.style.display='grid'; bar.style.gridTemplateColumns='1fr 1fr 1fr'; bar.style.alignItems='center';
          const left = document.createElement('div'); left.className='text-sm bold'; left.textContent='BIZOLVE';
          const center = document.createElement('div'); center.style.textAlign='center'; center.innerHTML = '<div class="text-xl">Duty Roster</div><div class="text-sm">for Hidhaya School / N. Miladhoo</div>';
          const right = document.createElement('div'); right.className='text-sm'; right.style.textAlign='right'; right.textContent = formatMonthYear(year, month);
          bar.append(left, center, right); wrap.appendChild(bar); return wrap;
        }

        function controls(){
          const wrap = document.createElement('div'); wrap.className='pad print-hide';
          const monthSel = document.createElement('select'); monthSel.className='select';
          const yearSel = document.createElement('select'); yearSel.className='select';
          for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent = new Date(2025,i,1).toLocaleString('en',{month:'short'}); if(i===month) o.selected=true; monthSel.appendChild(o); }
          const baseYear = new Date().getFullYear(); for(let i=-2;i<=3;i++){ const y=baseYear+i; const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); if(y===year) o.selected=true; yearSel.appendChild(o); }
          const prevBtn = document.createElement('button'); prevBtn.className='btn'; prevBtn.textContent='Prev';
          const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='Next';
          const printBtn = document.createElement('button'); printBtn.className='btn'; printBtn.textContent='Print / Save PDF'; printBtn.onclick = ()=>window.print();
          prevBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()-1); year=d.getFullYear(); month=d.getMonth(); subscribe(); };
          nextBtn.onclick = ()=>{ const d=new Date(year,month,1); d.setMonth(d.getMonth()+1); year=d.getFullYear(); month=d.getMonth(); subscribe(); };
          monthSel.onchange = ()=>{ month = parseInt(monthSel.value); subscribe(); };
          yearSel.onchange = ()=>{ year = parseInt(yearSel.value); subscribe(); };
          wrap.append(prevBtn, nextBtn, monthSel, yearSel, printBtn);
          return wrap;
        }

        function build(){
          root.innerHTML='';
          const len = daysInMonth(year, month);
          const som = startOfMonthWeekday(year, month);

          const nav = document.createElement('div'); nav.className='mbar print-hide'; nav.innerHTML = '<a class="btn" href="./WC.html">← Back to WC</a><div class="grow"></div>'; root.appendChild(nav);
          root.appendChild(header());
          root.appendChild(controls());

          const weekHead = document.createElement('div'); weekHead.className='grid7 muted text-xs center'; weekHead.style.margin='4px 10px';
          ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const el=document.createElement('div'); el.textContent=d; el.style.padding='2px 0'; weekHead.appendChild(el); });
          root.appendChild(weekHead);

          const prevMonthDate = new Date(year, month, 0);
          const prevDays = prevMonthDate.getDate();
          const leading = som;
          const trailing = (7 - ((leading + len) % 7)) % 7;
          const cells = [];
          for (let i=leading;i>0;i--) cells.push({ date: new Date(year, month-1, prevDays - i + 1), outside: true});
          for (let d=1; d<=len; d++) cells.push({ date: new Date(year, month, d), outside: false});
          for (let i=1; i<=trailing; i++) cells.push({ date: new Date(year, month+1, i), outside: true});

          const grid = document.createElement('div'); grid.className='grid7'; grid.style.margin='0 10px 10px';
          cells.forEach((cell)=>{
            const date = cell.date;
            const dNum = date.getDate();
            const dayKey = date.getMonth()===month ? dNum : null;
            const schoolHol = dayKey ? !!state.schoolMap[String(dayKey)] : false;
            const override = dayKey ? (state.overrides[String(dayKey)] ?? 0) : 0;
            const shifts = computeShiftsForDate(date, schoolHol, override);
            const isWeekend = isWeekendHoliday(date);
            const isHoliday = isWeekend || override===1;
            const isSchool = !isHoliday && (override===2 || (override===0 && schoolHol));
            const sorted = [...shifts].sort((a,b)=> displayStartMinute(a.time) - displayStartMinute(b.time));

            const cellDiv = document.createElement('div');
            cellDiv.className = 'cell' + (cell.outside?' muted':'') + (isHoliday?' holiday':'') + (isSchool?' school':'');
            if (dayKey){
              cellDiv.onclick = ()=> {
                const curr = state.overrides[String(dayKey)] ?? 0;
                const nxt = (curr + 1) % 3;
                state.overrides[String(dayKey)] = nxt;
                setDoc(rosterRef(year, month), { siteId: SITE_ID, year, month, overrides: state.overrides, schoolMap: state.schoolMap }, { merge: true });
              };
            }
            const mm = document.createElement('div'); mm.className='mm'; mm.textContent = monthShort(date.getFullYear(), date.getMonth());
            const wm = document.createElement('div'); wm.className='wm'; wm.textContent = String(dNum);
            cellDiv.append(mm, wm);

            const inner = document.createElement('div');
            inner.style.position='absolute'; inner.style.inset='0'; inner.style.display='flex'; inner.style.flexDirection='column'; inner.style.justifyContent='flex-end'; inner.style.zIndex='1';
            sorted.forEach((s,i)=>{
              const row = document.createElement('div'); row.className = 'row ' + (i%2===0?'altA':'altB') + (s.grey?' noduty':'');
              const t = document.createElement('div'); t.className='time'; t.textContent = s.time || '—';
              const n = document.createElement('div'); n.className='name'; n.textContent = s.staffId? shortName(staffName(s.staffId)) : '';
              row.append(t,n); inner.appendChild(row);
            });
            cellDiv.appendChild(inner);
            grid.appendChild(cellDiv);
          });
          root.appendChild(grid);

          const footer = document.createElement('div'); footer.id='foot'; footer.className='pad center text-xs'; footer.style.background='#f1f8e9'; footer.textContent = 'Supervised & Managed by Hassan Irfan Mohamed (BIZOLVE) — Electronic Signature Verified';
          root.appendChild(footer);
        }

        function subscribe(){
          if (typeof unsubscribe === 'function') unsubscribe();
          const ref = rosterRef(year, month);
          unsubscribe = onSnapshot(ref, snap=>{
            const d = snap.data() || {}; state.overrides = d.overrides || {}; state.schoolMap = d.schoolMap || {}; build();
          }, ()=>{ state.overrides = {}; state.schoolMap = {}; build(); });
        }

        subscribe();
      }

      window.addEventListener('DOMContentLoaded', ()=>{
        document.body.setAttribute('data-page','roster');
        render();
      });
    </script>
  </head>
  <body data-page="roster">
    <div id="app"></div>
  </body>
</html>
